<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Arena 2D - Multiplayer P2P</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Semantic Color Tokens */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            /* Typography */
            --font-family-base: "Arial", sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;

            /* Game specific colors */
            --player-host-color: #3B82F6;
            --player-client-color: #EF4444;
            --bullet-color: #FFF;
            --arena-bg: #1a1a1a;
            --arena-wall: #4a4a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-text);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        canvas {
            display: block;
            background: var(--arena-bg);
            border: 2px solid var(--color-border);
            touch-action: none;
            cursor: crosshair;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-16);
        }

        .menu {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .menu h1 {
            color: var(--color-primary);
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-32);
            font-weight: var(--font-weight-bold);
        }

        .menu h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-24);
        }

        .btn {
            display: block;
            width: 100%;
            padding: var(--space-16);
            margin: var(--space-8) 0;
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:active {
            background: var(--color-primary-active);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .input {
            width: 100%;
            padding: var(--space-12);
            margin: var(--space-8) 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            color: var(--color-text);
            font-size: var(--font-size-base);
        }

        .status {
            padding: var(--space-12);
            margin: var(--space-12) 0;
            border-radius: var(--radius-base);
            font-weight: var(--font-weight-medium);
        }

        .status-info {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .status-error {
            background: rgba(var(--color-red-500-rgb), 0.2);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        .status-success {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }

        .game-container {
            position: relative;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .room-code {
            font-family: monospace;
            font-size: var(--font-size-2xl);
            background: rgba(var(--color-teal-500-rgb), 0.1);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            border: 2px solid var(--color-primary);
            margin: var(--space-16) 0;
            letter-spacing: 2px;
        }

        /* User Info Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-16);
            background: rgba(var(--color-brown-600-rgb), 0.1);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-24);
            border: 1px solid var(--color-border);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
        }

        .user-email {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .btn-icon {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-8);
            cursor: pointer;
            color: var(--color-text);
            font-size: var(--font-size-lg);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--color-secondary-hover);
        }

        /* Lobby Styles - RESPONSIVE LAYOUT */
        .lobby-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: var(--space-20);
            height: 100vh;
            padding: var(--space-20);
            max-width: none;
        }

        .lobby-left {
            display: flex;
            flex-direction: column;
            gap: var(--space-20);
        }

        .lobby-right {
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.5);
            border-radius: var(--radius-md);
            padding: var(--space-20);
        }

        .room-code-box {
            background: rgba(26, 188, 156, 0.2);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            text-align: center;
            border: 1px solid var(--color-primary);
        }

        .room-code-box h3 {
            color: var(--color-primary);
            margin-bottom: var(--space-12);
        }

        .players-section {
            flex: 1;
            overflow-y: auto;
        }

        .character-selection-container {
            background: rgba(var(--color-brown-600-rgb), 0.1);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            border: 1px solid var(--color-border);
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-16);
            padding: var(--space-20) 0;
        }

        .character-card {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-12);
        }

        .character-card:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
            background: rgba(26, 188, 156, 0.2);
        }

        .character-card.selected {
            border-color: var(--color-error);
            background: rgba(231, 76, 60, 0.3);
        }

        .character-icon {
            font-size: 48px;
            margin-bottom: var(--space-8);
        }

        .character-name {
            font-size: var(--font-size-xs);
            text-align: center;
        }

        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
            min-height: 200px;
        }

        .chat-message {
            margin: var(--space-8) 0;
            line-height: 1.4;
        }

        .chat-message strong {
            color: var(--color-primary);
        }

        .chat-input-container {
            display: flex;
            gap: var(--space-12);
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: var(--radius-sm);
            padding: var(--space-12);
            color: var(--color-text);
        }

        .players-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .lobby-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12);
            margin: var(--space-8) 0;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
        }

        .lobby-player.host {
            border-left: 4px solid var(--color-primary);
        }

        .ready-button {
            width: 100%;
            padding: var(--space-16);
            background: var(--color-success);
            border: none;
            border-radius: var(--radius-base);
            color: white;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            margin-top: var(--space-20);
            transition: all 0.2s;
        }

        .ready-button:hover {
            background: var(--color-primary-hover);
        }

        .start-button {
            background: var(--color-error);
        }

        .btn-danger {
            background: var(--color-error);
            color: var(--color-btn-primary-text);
        }

        .btn-danger:hover {
            background: var(--color-red-400);
        }

        .player-status {
            font-size: var(--font-size-sm);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
        }

        .player-status.ready {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-success);
        }

        .player-status.waiting {
            background: rgba(var(--color-orange-500-rgb), 0.2);
            color: var(--color-warning);
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .lobby-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 300px;
                height: 100vh;
                padding: var(--space-12);
                gap: var(--space-12);
            }
            
            .character-selection {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--space-12);
            }
            
            .character-icon {
                font-size: 32px;
            }
            
            .lobby-right {
                max-height: 300px;
            }
            
            .chat-messages {
                min-height: 120px;
            }
            
            .room-code-box {
                padding: var(--space-12);
            }
            
            .ready-button, .btn {
                padding: var(--space-12);
                font-size: var(--font-size-base);
                min-height: 44px; /* Touch target size */
            }
        }
        
        /* GAME CONTROLS */
        .game-ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            color: white;
            font-family: var(--font-family-base);
        }
        
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .joystick {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }
        
        .joystick-handle {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .shoot-button {
            width: 80px;
            height: 80px;
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            position: absolute;
            right: 0;
            bottom: 0;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <div class="menu">
            <h1>‚öîÔ∏è Battle Arena 2D</h1>
            <p>Fa√ßa login para jogar e conectar com amigos</p>
            <button class="btn" onclick="game && game.signInWithGoogle()">üîê Login com Google</button>
            <div id="loginStatus" class="status status-info hidden">Conectando...</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="container hidden">
        <div class="menu">
            <h1>‚öîÔ∏è Battle Arena 2D</h1>
            <div id="userInfo" class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <div>
                    <div id="userName">Nome do Usu√°rio</div>
                    <div id="userEmail" class="user-email">email@example.com</div>
                </div>
                <button class="btn-icon" onclick="game && game.signOut()" title="Logout">üö™</button>
            </div>
            <button class="btn" onclick="game && game.showHostMenu()">üéØ Host Game</button>
            <button class="btn" onclick="game && game.showJoinMenu()">üîó Join Game</button>
            <button class="btn btn-secondary" onclick="game && game.showInstructions()">‚ùì How to Play</button>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="hidden">
        <div class="lobby-container">
            <!-- LADO ESQUERDO -->
            <div class="lobby-left">
                <div class="room-code-box">
                    <h3>C√≥digo da Sala</h3>
                    <div id="lobbyRoomCode" style="font-family: monospace; font-size: 24px; font-weight: bold; margin: 10px 0;">---</div>
                    <button id="copyCodeBtn" class="btn-secondary" onclick="game && game.copyRoomCode()">üìã Copiar C√≥digo</button>
                </div>
                
                <div class="players-section">
                    <h3>Jogadores</h3>
                    <div id="playersList" class="players-list"></div>
                </div>
                
                <div class="character-selection-container">
                    <h3>Escolha seu Personagem</h3>
                    <div class="character-selection" id="characterGrid">
                        <!-- Personagens renderizados aqui -->
                    </div>
                </div>
                
                <button id="readyButton" class="ready-button" onclick="game && game.toggleReady()" disabled>Escolha um personagem</button>
                <button id="startGameButton" class="ready-button start-button" style="display:none;" onclick="game && game.startGameAsHost()">üéÆ Iniciar Jogo</button>
                <button id="leaveRoomBtn" class="btn btn-danger" onclick="game && game.leaveRoom()">‚Üê Sair da Sala</button>
            </div>
            
            <!-- LADO DIREITO - CHAT -->
            <div class="lobby-right">
                <h3>üí¨ Chat</h3>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Digite uma mensagem..." maxlength="500">
                        <button id="sendChatBtn" class="btn btn-primary" onclick="game && game.sendChat()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Host Menu -->
    <div id="hostMenu" class="container hidden">
        <div class="menu">
            <h2>Host Game</h2>
            <div id="hostStatus" class="status status-info">Inicializando...</div>
            <div id="roomCodeContainer" class="hidden">
                <div class="room-code" id="roomCodeDisplay"></div>
                <button class="btn btn-secondary" onclick="game && game.copyRoomCode()">üìã Copy Code</button>
            </div>
            <div id="waitingMessage" class="hidden">
                <p>Compartilhe este c√≥digo com seus amigos!</p>
                <p>Aguardando jogadores...</p>
            </div>
            <button class="btn btn-secondary" onclick="game && game.showMainMenu()">‚Üê Back</button>
        </div>
    </div>

    <!-- Join Menu -->
    <div id="joinMenu" class="container hidden">
        <div class="menu">
            <h2>Join Game</h2>
            <input type="text" id="roomCodeInput" class="input" placeholder="Digite o c√≥digo da sala" maxlength="10">
            <button class="btn" onclick="game && game.pasteRoomCode()">üìã Colar C√≥digo</button>
            <button class="btn" onclick="game && game.joinRoom()">Conectar</button>
            <div id="joinStatus" class="status status-info hidden">Conectando...</div>
            <button class="btn btn-secondary" onclick="game && game.showMainMenu()">‚Üê Back</button>
        </div>
    </div>

    <!-- Instructions -->
    <div id="instructionsMenu" class="container hidden">
        <div class="menu">
            <h2>Como Jogar</h2>
            <div style="text-align: left; line-height: 1.6;">
                <p><strong>Controles Desktop:</strong></p>
                <p>‚Ä¢ WASD - Mover</p>
                <p>‚Ä¢ Mouse - Mirar &amp; Atirar</p>
                <p>‚Ä¢ ESC - Pausar</p>
                <br>
                <p><strong>Controles Mobile:</strong></p>
                <p>‚Ä¢ Joystick esquerdo - Mover</p>
                <p>‚Ä¢ Bot√£o direito - Atirar</p>
                <br>
                <p><strong>Objetivo:</strong></p>
                <p>‚Ä¢ Elimine seus oponentes</p>
                <p>‚Ä¢ Primeiro a 10 kills vence!</p>
                <p>‚Ä¢ Respawn ap√≥s 3 segundos</p>
            </div>
            <button class="btn" onclick="game && game.showMainMenu()">‚Üê Voltar</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- Game UI -->
        <div class="game-ui" id="gameUI" style="display: none;">
            <div id="healthDisplay">Vida: 100/100</div>
            <div id="scoreDisplay">Score: 0</div>
            <div id="characterDisplay">Personagem: -</div>
            <button class="btn btn-secondary" onclick="game && game.pauseGame()" style="margin-top: 10px;">Pausar</button>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mobile-controls" id="mobileControls" style="display: none;">
            <div class="joystick" id="joystick">
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>
            <button class="shoot-button" id="shootButton">üéØ</button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverMenu" class="container hidden">
        <div class="menu">
            <h2 id="gameOverTitle">Game Over!</h2>
            <div id="gameOverStats"></div>
            <button class="btn" onclick="game && game.showMainMenu()">Menu Principal</button>
        </div>
    </div>

    <!-- PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- √öNICO SCRIPT TYPE="MODULE" -->
    <script type="module">
        // 1. IMPORTS DO FIREBASE (apenas uma vez!)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // 2. DECLARAR VARI√ÅVEIS GLOBAIS APENAS UMA VEZ
        let firebaseApp;
        let auth;
        let db;
        let currentUser = null;
        let peer = null;
        let connection = null;
        let game = null;
        let selectedCharacter = null;
        let isHost = false;
        let roomCode = '';
        let lobbyUnsubscribe = null;
        let chatUnsubscribe = null;
        let isReady = false;
        let roomData = null;
        
        // 3. CONFIG DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB6ho-GUxFGjjQprHHuxCDswIpWy9jtpcU",
            authDomain: "battlearena2dperplexity.firebaseapp.com",
            projectId: "battlearena2dperplexity",
            storageBucket: "battlearena2dperplexity.firebasestorage.app",
            messagingSenderId: "180775815859",
            appId: "1:180775815859:web:23b54f48f1e093ef0f3ec6",
            measurementId: "G-89P0EVPL9X"
        };

        // 4. CLASSE DE EFEITOS VISUAIS
        class VisualEffects {
            constructor(ctx) {
                this.ctx = ctx;
                this.particles = [];
            }
            
            // Balas tracejantes com glow
            drawBullet(bullet) {
                const ctx = this.ctx;
                
                // Glow effect
                ctx.save();
                ctx.shadowBlur = 15;
                ctx.shadowColor = bullet.color || '#ff6b6b';
                
                // Trail
                ctx.strokeStyle = bullet.color || '#ff6b6b';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(bullet.x - bullet.vx * 5, bullet.y - bullet.vy * 5);
                ctx.lineTo(bullet.x, bullet.y);
                ctx.stroke();
                
                // Bullet core
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
            
            // Part√≠culas de sangue ao acertar jogador
            createBloodParticles(x, y) {
                for (let i = 0; i < 15; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        size: Math.random() * 4 + 2,
                        life: 1,
                        type: 'blood',
                        color: '#c0392b'
                    });
                }
            }
            
            // Fragmenta√ß√£o ao colidir com obst√°culo
            createFragments(x, y, color = '#95a5a6') {
                for (let i = 0; i < 10; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 6,
                        vy: (Math.random() - 0.5) * 6,
                        size: Math.random() * 3 + 1,
                        life: 1,
                        type: 'fragment',
                        color: color
                    });
                }
            }
            
            // Explos√£o ao usar habilidade especial
            createExplosion(x, y, color = '#e74c3c') {
                for (let i = 0; i < 30; i++) {
                    const angle = (Math.PI * 2 * i) / 30;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * 10,
                        vy: Math.sin(angle) * 10,
                        size: Math.random() * 5 + 3,
                        life: 1,
                        type: 'explosion',
                        color: color
                    });
                }
            }
            
            // Atualizar e renderizar part√≠culas
            update() {
                this.particles = this.particles.filter(p => p.life > 0);
                
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vx *= 0.95;
                    p.vy *= 0.95;
                    p.life -= 0.02;
                    
                    // Renderizar
                    this.ctx.save();
                    this.ctx.globalAlpha = p.life;
                    this.ctx.fillStyle = p.color;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.restore();
                });
            }
        }
        
        // 5. SISTEMA DE COMBATE
        class CombatSystem {
            constructor(game) {
                this.game = game;
                this.bullets = [];
                this.obstacles = this.createObstacles();
            }
            
            createObstacles() {
                return [
                    { x: 200, y: 150, w: 100, h: 20, destructible: false, health: 100, color: '#7f8c8d' },
                    { x: 500, y: 300, w: 20, h: 100, destructible: false, health: 100, color: '#7f8c8d' },
                    { x: 800, y: 200, w: 80, h: 80, destructible: true, health: 50, color: '#95a5a6' },
                    { x: 300, y: 450, w: 150, h: 30, destructible: false, health: 100, color: '#7f8c8d' }
                ];
            }
            
            // Criar bala
            shoot(player, targetX, targetY) {
                const char = this.getCharacterStats(player.character || 'warrior');
                const angle = Math.atan2(targetY - player.y, targetX - player.x);
                
                // Verificar cooldown
                const now = Date.now();
                if (player.lastShot && now - player.lastShot < char.fireRate) {
                    return null;
                }
                
                player.lastShot = now;
                
                const bullet = {
                    id: this.generateId(),
                    ownerId: player.id || 'local',
                    x: player.x,
                    y: player.y,
                    vx: Math.cos(angle) * 10,
                    vy: Math.sin(angle) * 10,
                    damage: char.damage,
                    range: char.range,
                    distanceTraveled: 0,
                    color: player.color || '#ff6b6b'
                };
                
                this.bullets.push(bullet);
                return bullet;
            }
            
            generateId() {
                return Math.random().toString(36).substr(2, 9);
            }
            
            getCharacterStats(characterId) {
                const stats = {
                    warrior: { damage: 25, fireRate: 500, range: 600, health: 100 },
                    mage: { damage: 35, fireRate: 800, range: 700, health: 80 },
                    archer: { damage: 30, fireRate: 400, range: 800, health: 90 },
                    assassin: { damage: 40, fireRate: 600, range: 500, health: 70 },
                    tank: { damage: 20, fireRate: 700, range: 400, health: 150 },
                    sniper: { damage: 60, fireRate: 1200, range: 1000, health: 75 },
                    healer: { damage: 15, fireRate: 300, range: 500, health: 85 },
                    pyro: { damage: 30, fireRate: 200, range: 300, health: 95 },
                    engineer: { damage: 25, fireRate: 500, range: 600, health: 100 },
                    berserker: { damage: 35, fireRate: 300, range: 400, health: 120 },
                    ninja: { damage: 30, fireRate: 250, range: 500, health: 80 },
                    paladin: { damage: 28, fireRate: 600, range: 550, health: 110 }
                };
                return stats[characterId] || stats.warrior;
            }
            
            // Atualizar balas
            updateBullets(players, effects) {
                this.bullets = this.bullets.filter(bullet => {
                    // Mover bala
                    bullet.x += bullet.vx;
                    bullet.y += bullet.vy;
                    bullet.distanceTraveled += Math.sqrt(bullet.vx ** 2 + bullet.vy ** 2);
                    
                    // Verificar alcance m√°ximo
                    if (bullet.distanceTraveled > bullet.range) {
                        return false;
                    }
                    
                    // Verificar colis√£o com jogadores
                    for (let [playerId, player] of players) {
                        if (playerId === bullet.ownerId || !player.isAlive) continue;
                        
                        const dist = Math.sqrt((bullet.x - player.x) ** 2 + (bullet.y - player.y) ** 2);
                        
                        if (dist < 20) {
                            // Aplicar dano
                            player.health -= bullet.damage;
                            
                            // Efeitos visuais de sangue
                            effects.createBloodParticles(bullet.x, bullet.y);
                            
                            // Verificar morte
                            if (player.health <= 0) {
                                player.health = 0;
                                player.isAlive = false;
                                effects.createExplosion(player.x, player.y, '#c0392b');
                                
                                // Respawn ap√≥s 3 segundos
                                setTimeout(() => {
                                    const char = this.getCharacterStats(player.character || 'warrior');
                                    player.health = char.health;
                                    player.isAlive = true;
                                    player.x = Math.random() * 1200;
                                    player.y = Math.random() * 700;
                                }, 3000);
                            }
                            
                            return false;
                        }
                    }
                    
                    // Verificar colis√£o com obst√°culos
                    for (let i = this.obstacles.length - 1; i >= 0; i--) {
                        const obstacle = this.obstacles[i];
                        if (bullet.x > obstacle.x && bullet.x < obstacle.x + obstacle.w &&
                            bullet.y > obstacle.y && bullet.y < obstacle.y + obstacle.h) {
                            
                            // Efeitos de fragmenta√ß√£o
                            effects.createFragments(bullet.x, bullet.y, obstacle.color);
                            
                            // Destruir obst√°culo se for destru√≠vel
                            if (obstacle.destructible) {
                                obstacle.health -= bullet.damage;
                                if (obstacle.health <= 0) {
                                    this.obstacles.splice(i, 1);
                                    effects.createExplosion(obstacle.x + obstacle.w/2, obstacle.y + obstacle.h/2);
                                }
                            }
                            
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            renderObstacles(ctx) {
                this.obstacles.forEach(obstacle => {
                    ctx.fillStyle = obstacle.color;
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);
                    
                    if (obstacle.destructible && obstacle.health < 50) {
                        ctx.strokeStyle = '#e74c3c';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);
                    }
                });
            }
        }

        // 6. GAME CLASS
        class BattleArena2D {
            constructor() {
                console.log('Inicializando Battle Arena 2D...');
                this.canvas = document.getElementById('gameCanvas');
                if (!this.canvas) {
                    throw new Error('Canvas n√£o encontrado');
                }
                
                this.ctx = this.canvas.getContext('2d');
                this.gameState = 'menu';
                this.playerName = 'Jogador';
                
                // Inicializar sistemas
                this.effects = new VisualEffects(this.ctx);
                this.combat = new CombatSystem(this);
                
                // Game objects
                this.localPlayer = {
                    x: 400,
                    y: 300,
                    angle: 0,
                    health: 100,
                    maxHealth: 100,
                    score: 0,
                    isAlive: true,
                    id: 'local',
                    character: null,
                    color: '#00ff00',
                    lastShot: 0
                };
                
                this.remotePlayers = new Map();
                this.lastTime = 0;
                
                // Controls
                this.keys = {};
                this.mouse = { x: 0, y: 0 };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.gameLoop();
            }
            
            setupEventListeners() {
                // Keyboard
                window.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Mouse
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouse.x = e.clientX - rect.left;
                    this.mouse.y = e.clientY - rect.top;
                });
                
                this.canvas.addEventListener('mousedown', (e) => {
                    if (this.gameState === 'playing') {
                        this.shoot();
                    }
                });
                
                // Touch controls
                this.setupTouchControls();
            }
            
            // Menu functions
            showLoginScreen() {
                this.hideAllMenus();
                document.getElementById('loginScreen').classList.remove('hidden');
            }
            
            showMainMenu() {
                this.hideAllMenus();
                if (currentUser) {
                    document.getElementById('mainMenu').classList.remove('hidden');
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            }
            
            showHostMenu() {
                this.hideAllMenus();
                document.getElementById('hostMenu').classList.remove('hidden');
                // Aguardar um momento antes de criar host para UI atualizar
                setTimeout(() => this.createHost(), 100);
            }
            
            showJoinMenu() {
                this.hideAllMenus();
                document.getElementById('joinMenu').classList.remove('hidden');
            }
            
            showInstructions() {
                this.hideAllMenus();
                document.getElementById('instructionsMenu').classList.remove('hidden');
            }
            
            hideAllMenus() {
                const menus = ['loginScreen', 'mainMenu', 'hostMenu', 'joinMenu', 'instructionsMenu', 'gameOverMenu', 'lobbyScreen'];
                menus.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById('gameContainer').style.display = 'none';
            }
            
            // Firebase Authentication COM CORRE√á√ÉO DO POPUP
            async signInWithGoogle() {
                try {
                    const statusElement = document.getElementById('loginStatus');
                    statusElement.classList.remove('hidden');
                    statusElement.textContent = 'Conectando...';
                    statusElement.className = 'status status-info';
                    
                    const provider = new GoogleAuthProvider();
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });
                    
                    // Usar signInWithPopup com tratamento de erro espec√≠fico
                    const result = await signInWithPopup(auth, provider);
                    currentUser = result.user;
                    
                    // Salvar usu√°rio no Firestore
                    await setDoc(doc(db, 'users', result.user.uid), {
                        uid: result.user.uid,
                        email: result.user.email,
                        displayName: result.user.displayName,
                        photoURL: result.user.photoURL,
                        lastSeen: serverTimestamp(),
                        online: true
                    }, { merge: true });
                    
                    console.log('Login bem-sucedido:', result.user.email);
                    
                    statusElement.textContent = 'Login realizado com sucesso!';
                    statusElement.className = 'status status-success';
                    
                } catch (error) {
                    console.error('Erro no login:', error.code, error.message);
                    const statusElement = document.getElementById('loginStatus');
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        statusElement.textContent = 'Voc√™ fechou o popup de login. Tente novamente.';
                    } else if (error.code === 'auth/popup-blocked') {
                        statusElement.textContent = 'Popup bloqueado pelo navegador. Permita popups para este site.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        statusElement.textContent = 'Dom√≠nio n√£o autorizado. Configure o dom√≠nio no Firebase Console.';
                    } else {
                        statusElement.textContent = 'Erro ao fazer login: ' + error.message;
                    }
                    statusElement.className = 'status status-error';
                }
            }
            
            async signOut() {
                try {
                    await signOut(auth);
                    currentUser = null;
                    console.log('Logout realizado');
                } catch (error) {
                    console.error('Erro no logout:', error);
                }
            }
            
            async createUserProfile() {
                if (!currentUser) return;
                
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (!userSnap.exists()) {
                        await setDoc(userRef, {
                            uid: currentUser.uid,
                            name: currentUser.displayName || 'Usu√°rio',
                            email: currentUser.email,
                            photoURL: currentUser.photoURL || '',
                            createdAt: serverTimestamp(),
                            isOnline: true
                        });
                    } else {
                        await updateDoc(userRef, {
                            isOnline: true,
                            name: currentUser.displayName,
                            photoURL: currentUser.photoURL
                        });
                    }
                    
                    this.updateUserUI();
                } catch (error) {
                    console.error('Erro ao criar perfil:', error);
                }
            }
            
            updateUserUI() {
                if (!currentUser) return;
                
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName) userName.textContent = currentUser.displayName || 'Usu√°rio';
                if (userEmail) userEmail.textContent = currentUser.email || '';
                if (userAvatar) {
                    userAvatar.src = currentUser.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><rect width="40" height="40" fill="%23cccccc"/><text x="50%" y="55%" font-size="16" text-anchor="middle" fill="%23666666">üë§</text></svg>';
                }
            }
            
            // FIRESTORE + P2P NETWORKING COM CORRE√á√ïES
            async createHost() {
                try {
                    isHost = true;
                    roomCode = this.generateRoomCode();
                    
                    document.getElementById('hostStatus').textContent = 'Criando sala...';
                    
                    // Criar sala no Firestore
                    await setDoc(doc(db, 'rooms', roomCode), {
                        hostId: currentUser.uid,
                        hostName: currentUser.displayName,
                        players: [{
                            uid: currentUser.uid,
                            name: currentUser.displayName,
                            character: null,
                            ready: false,
                            isHost: true
                        }],
                        gameMode: 'deathmatch',
                        maxPlayers: 8,
                        status: 'lobby',
                        createdAt: serverTimestamp()
                    });
                    
                    // Iniciar peer
                    peer = new Peer(roomCode);
                    
                    peer.on('open', (id) => {
                        console.log('Sala criada:', id);
                        document.getElementById('hostStatus').textContent = 'Sala criada!';
                        document.getElementById('roomCodeDisplay').textContent = roomCode;
                        document.getElementById('roomCodeContainer').classList.remove('hidden');
                        document.getElementById('waitingMessage').classList.remove('hidden');
                        
                        // Ir para o lobby ap√≥s breve delay
                        setTimeout(() => {
                            this.hideAllMenus();
                            this.showLobby();
                        }, 1500);
                    });
                    
                    peer.on('connection', (conn) => {
                        connection = conn;
                        this.setupConnection(conn);
                    });
                    
                    peer.on('error', (err) => {
                        console.error('Erro P2P:', err);
                        document.getElementById('hostStatus').textContent = 'Erro: ' + err.message;
                        document.getElementById('hostStatus').className = 'status status-error';
                    });
                    
                } catch (error) {
                    console.error('Erro ao criar sala:', error);
                    document.getElementById('hostStatus').textContent = 'Erro ao criar sala: ' + error.message;
                    document.getElementById('hostStatus').className = 'status status-error';
                }
            }
            
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            async joinRoom() {
                const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
                if (!code) return;
                
                try {
                    isHost = false;
                    roomCode = code;
                    
                    document.getElementById('joinStatus').classList.remove('hidden');
                    document.getElementById('joinStatus').textContent = 'Verificando sala...';
                    
                    // Verificar se sala existe
                    const roomRef = doc(db, 'rooms', code);
                    const roomSnap = await getDoc(roomRef);
                    
                    if (!roomSnap.exists()) {
                        document.getElementById('joinStatus').textContent = 'Sala n√£o encontrada!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    const currentRoomData = roomSnap.data();
                    
                    if (currentRoomData.players.length >= currentRoomData.maxPlayers) {
                        document.getElementById('joinStatus').textContent = 'Sala cheia!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    if (currentRoomData.status !== 'lobby') {
                        document.getElementById('joinStatus').textContent = 'Jogo j√° iniciado!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    document.getElementById('joinStatus').textContent = 'Conectando...';
                    
                    // Adicionar jogador √† sala no Firestore
                    await updateDoc(roomRef, {
                        players: arrayUnion({
                            uid: currentUser.uid,
                            name: currentUser.displayName,
                            character: null,
                            ready: false,
                            isHost: false
                        })
                    });
                    
                    // Conectar via P2P
                    peer = new Peer();
                    
                    peer.on('open', () => {
                        connection = peer.connect(code);
                        this.setupConnection(connection);
                        
                        document.getElementById('joinStatus').textContent = 'Conectado!';
                        document.getElementById('joinStatus').className = 'status status-success';
                        
                        setTimeout(() => {
                            this.hideAllMenus();
                            this.showLobby();
                        }, 1000);
                    });
                    
                    peer.on('error', (err) => {
                        console.error('Erro P2P:', err);
                        document.getElementById('joinStatus').textContent = 'Erro de conex√£o: ' + err.message;
                        document.getElementById('joinStatus').className = 'status status-error';
                    });
                    
                } catch (error) {
                    console.error('Erro ao entrar na sala:', error);
                    document.getElementById('joinStatus').textContent = 'Erro ao entrar na sala: ' + error.message;
                    document.getElementById('joinStatus').className = 'status status-error';
                }
            }
            
            setupConnection(conn) {
                conn.on('open', () => {
                    console.log('Conex√£o P2P estabelecida');
                    if (isHost) {
                        document.getElementById('hostStatus').textContent = 'Jogador conectado!';
                    } else {
                        document.getElementById('joinStatus').textContent = 'Conectado!';
                        document.getElementById('joinStatus').className = 'status status-success';
                    }
                });
                
                conn.on('data', (data) => {
                    this.handleNetworkData(data);
                });
                
                conn.on('close', () => {
                    alert('Conex√£o perdida!');
                    this.leaveRoom();
                });
                
                conn.on('error', (err) => {
                    console.error('Erro P2P:', err);
                });
            }
            
            // MOSTRAR LOBBY
            showLobby() {
                this.hideAllMenus();
                document.getElementById('lobbyScreen').classList.remove('hidden');
                document.getElementById('lobbyRoomCode').textContent = `C√≥digo: ${roomCode}`;
                
                this.initializeCharacters();
                this.listenToLobbyChanges();
                this.setupLobbyChat();
                
                // Setup chat input
                const chatInput = document.getElementById('chatInput');
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChat();
                    }
                });
            }
            
            // ESCUTAR MUDAN√áAS NO LOBBY EM TEMPO REAL
            listenToLobbyChanges() {
                const roomRef = doc(db, 'rooms', roomCode);
                
                lobbyUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        roomData = docSnap.data();
                        this.updateLobbyUI(roomData);
                    }
                });
            }
            
            // ATUALIZAR UI DO LOBBY
            updateLobbyUI(roomData) {
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';
                
                roomData.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `lobby-player ${player.isHost ? 'host' : ''}`;
                    
                    const characterName = player.character ? this.getCharacterName(player.character) : 'Escolhendo...';
                    const statusText = player.ready ? '‚úì Pronto' : '‚è≥ Aguardando';
                    const statusClass = player.ready ? 'ready' : 'waiting';
                    
                    playerDiv.innerHTML = `
                        <div>
                            <strong>${player.name}</strong>
                            ${player.isHost ? '<span style="color: var(--color-primary);"> (Host)</span>' : ''}
                        </div>
                        <div>${characterName}</div>
                        <div class="player-status ${statusClass}">${statusText}</div>
                    `;
                    playersList.appendChild(playerDiv);
                });
                
                // Atualizar bot√£o de iniciar jogo (apenas host)
                if (isHost) {
                    const startButton = document.getElementById('startGameButton');
                    const allReady = roomData.players.length > 1 && 
                                   roomData.players.every(p => p.ready && p.character);
                    
                    if (allReady) {
                        startButton.classList.remove('hidden');
                    } else {
                        startButton.classList.add('hidden');
                    }
                }
            }
            
            // INICIALIZAR PERSONAGENS COM √çCONES CORRETOS
            initializeCharacters() {
                const characters = [
                    { id: 'warrior', name: 'Guerreiro', emoji: '‚öîÔ∏è' },
                    { id: 'mage', name: 'Mago', emoji: 'üîÆ' },
                    { id: 'archer', name: 'Arqueiro', emoji: 'üèπ' },
                    { id: 'assassin', name: 'Assassino', emoji: 'üó°Ô∏è' },
                    { id: 'tank', name: 'Tanque', emoji: 'üõ°Ô∏è' },
                    { id: 'sniper', name: 'Atirador', emoji: 'üéØ' },
                    { id: 'healer', name: 'Curandeiro', emoji: 'üíö' },
                    { id: 'pyro', name: 'Piroman√≠aco', emoji: 'üî•' },
                    { id: 'engineer', name: 'Engenheiro', emoji: 'üîß' },
                    { id: 'berserker', name: 'Berserker', emoji: '‚ö°' },
                    { id: 'ninja', name: 'Ninja', emoji: 'ü•∑' },
                    { id: 'paladin', name: 'Paladino', emoji: '‚ö°' }
                ];
                
                const characterGrid = document.getElementById('characterGrid');
                characterGrid.innerHTML = '';
                
                characters.forEach(character => {
                    const characterCard = document.createElement('div');
                    characterCard.className = 'character-card';
                    characterCard.onclick = () => this.selectCharacter(character.id);
                    
                    characterCard.innerHTML = `
                        <div class="character-icon">${character.emoji}</div>
                        <div class="character-name">${character.name}</div>
                    `;
                    
                    characterGrid.appendChild(characterCard);
                });
            }
            
            getCharacterName(id) {
                const names = {
                    warrior: 'Guerreiro',
                    mage: 'Mago', 
                    archer: 'Arqueiro',
                    assassin: 'Assassino',
                    tank: 'Tanque',
                    sniper: 'Atirador',
                    healer: 'Curandeiro',
                    pyro: 'Piroman√≠aco',
                    engineer: 'Engenheiro',
                    berserker: 'Berserker',
                    ninja: 'Ninja',
                    paladin: 'Paladino'
                };
                return names[id] || 'Desconhecido';
            }
            
            // SELECIONAR PERSONAGEM
            async selectCharacter(characterId) {
                selectedCharacter = characterId;
                
                // Atualizar UI
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.character-card').classList.add('selected');
                
                // Habilitar bot√£o ready
                const readyButton = document.getElementById('readyButton');
                readyButton.textContent = isReady ? 'N√£o Pronto' : 'Pronto';
                readyButton.disabled = false;
                
                // Atualizar no Firestore
                try {
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    const currentRoomData = roomSnap.data();
                    
                    const updatedPlayers = currentRoomData.players.map(p => {
                        if (p.uid === currentUser.uid) {
                            return { ...p, character: characterId };
                        }
                        return p;
                    });
                    
                    await updateDoc(roomRef, { players: updatedPlayers });
                    
                } catch (error) {
                    console.error('Erro ao selecionar personagem:', error);
                }
            }
            
            handleNetworkData(data) {
                switch (data.type) {
                    case 'START_GAME':
                        this.initializeGame(data.players);
                        break;
                    case 'GAME_STATE':
                        this.updateGameState(data);
                        break;
                    case 'player_update':
                        if (!this.remotePlayers.has(data.playerId)) {
                            this.remotePlayers.set(data.playerId, {});
                        }
                        const player = this.remotePlayers.get(data.playerId);
                        Object.assign(player, data);
                        break;
                        
                    case 'bullet':
                        this.combat.bullets.push(data.bullet);
                        break;
                }
            }
            
            // TOGGLE READY
            async toggleReady() {
                if (!selectedCharacter) return;
                
                isReady = !isReady;
                
                // Atualizar UI
                const readyButton = document.getElementById('readyButton');
                readyButton.textContent = isReady ? 'N√£o Pronto' : 'Pronto';
                
                // Atualizar no Firestore
                try {
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    const currentRoomData = roomSnap.data();
                    
                    const updatedPlayers = currentRoomData.players.map(p => {
                        if (p.uid === currentUser.uid) {
                            return { ...p, ready: isReady };
                        }
                        return p;
                    });
                    
                    await updateDoc(roomRef, { players: updatedPlayers });
                    
                } catch (error) {
                    console.error('Erro ao marcar como pronto:', error);
                }
            }
            
            // SETUP CHAT DO LOBBY
            setupLobbyChat() {
                const chatRef = collection(db, 'rooms', roomCode, 'chat');
                const q = query(chatRef, orderBy('timestamp', 'asc'));
                
                chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    const chatBox = document.getElementById('chatMessages');
                    chatBox.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const msg = doc.data();
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';
                        msgDiv.innerHTML = `<strong>${msg.userName}:</strong> ${msg.message}`;
                        chatBox.appendChild(msgDiv);
                    });
                    
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            }
            
            // ENVIAR MENSAGEM NO CHAT
            async sendChat() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                try {
                    await addDoc(collection(db, 'rooms', roomCode, 'chat'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        message: message,
                        timestamp: serverTimestamp()
                    });
                    
                    chatInput.value = '';
                } catch (error) {
                    console.error('Erro ao enviar mensagem:', error);
                }
            }
            
            // INICIAR JOGO COMO HOST
            async startGameAsHost() {
                if (!isHost) return;
                
                try {
                    // Atualizar status da sala
                    await updateDoc(doc(db, 'rooms', roomCode), {
                        status: 'playing'
                    });
                    
                    // Enviar comando de in√≠cio via P2P
                    if (connection && connection.open) {
                        connection.send({
                            type: 'START_GAME',
                            players: roomData.players
                        });
                    }
                    
                    // Iniciar jogo localmente
                    this.initializeGame(roomData.players);
                    
                } catch (error) {
                    console.error('Erro ao iniciar jogo:', error);
                }
            }
            
            // INICIALIZAR JOGO
            initializeGame(players) {
                this.gameState = 'playing';
                this.hideAllMenus();
                document.getElementById('gameContainer').style.display = 'block';
                document.getElementById('gameUI').style.display = 'block';
                
                // Show mobile controls if on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('mobileControls').style.display = 'block';
                }
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Configurar jogador local com personagem selecionado
                const myPlayer = players.find(p => p.uid === currentUser.uid);
                if (myPlayer) {
                    this.localPlayer.character = myPlayer.character;
                    const stats = this.combat.getCharacterStats(myPlayer.character);
                    this.localPlayer.health = stats.health;
                    this.localPlayer.maxHealth = stats.health;
                }
                
                // Reset posi√ß√£o
                this.localPlayer.x = Math.random() * (this.canvas.width - 200) + 100;
                this.localPlayer.y = Math.random() * (this.canvas.height - 200) + 100;
                this.localPlayer.score = 0;
                this.localPlayer.isAlive = true;
                
                // Configurar jogadores remotos
                players.forEach(player => {
                    if (player.uid !== currentUser.uid) {
                        const stats = this.combat.getCharacterStats(player.character);
                        this.remotePlayers.set(player.uid, {
                            x: Math.random() * (this.canvas.width - 200) + 100,
                            y: Math.random() * (this.canvas.height - 200) + 100,
                            angle: 0,
                            health: stats.health,
                            maxHealth: stats.health,
                            score: 0,
                            isAlive: true,
                            id: player.uid,
                            character: player.character,
                            color: '#ff0000',
                            name: player.name
                        });
                    }
                });
                
                this.updateGameUI();
                console.log('Jogo iniciado com jogadores:', players);
            }
            
            // SAIR DA SALA
            async leaveRoom() {
                try {
                    // Hide game UI
                    document.getElementById('gameUI').style.display = 'none';
                    document.getElementById('mobileControls').style.display = 'none';
                    
                    // Remover do Firestore
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    
                    if (roomSnap.exists()) {
                        const currentRoomData = roomSnap.data();
                        const updatedPlayers = currentRoomData.players.filter(p => p.uid !== currentUser.uid);
                        
                        if (updatedPlayers.length === 0) {
                            // √öltima pessoa, deletar sala
                            await deleteDoc(roomRef);
                        } else {
                            await updateDoc(roomRef, { players: updatedPlayers });
                        }
                    }
                    
                    // Desconectar listeners
                    if (lobbyUnsubscribe) {
                        lobbyUnsubscribe();
                        lobbyUnsubscribe = null;
                    }
                    if (chatUnsubscribe) {
                        chatUnsubscribe();
                        chatUnsubscribe = null;
                    }
                    
                    // Fechar conex√µes P2P
                    if (connection) {
                        connection.close();
                        connection = null;
                    }
                    if (peer) {
                        peer.destroy();
                        peer = null;
                    }
                    
                    // Reset vari√°veis
                    isHost = false;
                    isReady = false;
                    selectedCharacter = null;
                    roomCode = '';
                    roomData = null;
                    
                    // Reset game state
                    this.gameState = 'menu';
                    this.remotePlayers.clear();
                    this.combat.bullets = [];
                    this.effects.particles = [];
                    
                    this.showMainMenu();
                    
                } catch (error) {
                    console.error('Erro ao sair da sala:', error);
                    // For√ßar volta ao menu mesmo com erro
                    this.showMainMenu();
                }
            }
            
            // Copy/Paste functionality
            async copyRoomCode() {
                try {
                    await navigator.clipboard.writeText(roomCode);
                    alert('C√≥digo copiado!');
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = roomCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('C√≥digo copiado!');
                }
            }
            
            async pasteRoomCode() {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('roomCodeInput').value = text.trim().toUpperCase();
                } catch (err) {
                    alert('Cole o c√≥digo manualmente.');
                }
            }
            
            // Game logic
            startGame() {
                this.gameState = 'playing';
                this.hideAllMenus();
                document.getElementById('gameContainer').style.display = 'block';
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Reset player
                this.localPlayer.x = 400;
                this.localPlayer.y = 300;
                this.localPlayer.health = 100;
                this.localPlayer.score = 0;
                this.localPlayer.isAlive = true;
            }
            
            updateGame(deltaTime) {
                if (this.gameState !== 'playing') return;
                
                this.updatePlayer(deltaTime);
                
                // Atualizar sistemas
                this.combat.updateBullets(this.getAllPlayers(), this.effects);
                this.effects.update();
                
                // Atualizar UI com nova informa√ß√£o de vida
                this.updateGameUI();
                
                this.sendPlayerUpdate();
            }
            
            getAllPlayers() {
                const allPlayers = new Map();
                allPlayers.set('local', this.localPlayer);
                this.remotePlayers.forEach((player, id) => {
                    allPlayers.set(id, player);
                });
                return allPlayers;
            }
            
            updatePlayer(deltaTime) {
                if (!this.localPlayer.isAlive) return;
                
                let moveX = 0, moveY = 0;
                const speed = 200 * deltaTime; // pixels per second
                
                if (this.keys['KeyW'] || this.keys['ArrowUp']) moveY -= 1;
                if (this.keys['KeyS'] || this.keys['ArrowDown']) moveY += 1;
                if (this.keys['KeyA'] || this.keys['ArrowLeft']) moveX -= 1;
                if (this.keys['KeyD'] || this.keys['ArrowRight']) moveX += 1;
                
                // Normalize diagonal movement
                if (moveX !== 0 || moveY !== 0) {
                    const length = Math.sqrt(moveX * moveX + moveY * moveY);
                    moveX = (moveX / length) * speed;
                    moveY = (moveY / length) * speed;
                }
                
                this.localPlayer.x += moveX;
                this.localPlayer.y += moveY;
                
                // Bounds checking
                this.localPlayer.x = Math.max(15, Math.min(this.canvas.width - 15, this.localPlayer.x));
                this.localPlayer.y = Math.max(15, Math.min(this.canvas.height - 15, this.localPlayer.y));
                
                // Update angle for aiming
                const dx = this.mouse.x - this.localPlayer.x;
                const dy = this.mouse.y - this.localPlayer.y;
                this.localPlayer.angle = Math.atan2(dy, dx);
            }
            

            
            shoot() {
                if (!this.localPlayer.isAlive) return;
                
                const bullet = this.combat.shoot(this.localPlayer, this.mouse.x, this.mouse.y);
                
                if (bullet) {
                    // Send bullet to opponent
                    if (connection && connection.open) {
                        connection.send({
                            type: 'bullet',
                            bullet: bullet
                        });
                    }
                }
            }
            
            sendPlayerUpdate() {
                if (connection && connection.open) {
                    connection.send({
                        type: 'player_update',
                        playerId: 'remote',
                        x: this.localPlayer.x,
                        y: this.localPlayer.y,
                        angle: this.localPlayer.angle,
                        health: this.localPlayer.health,
                        score: this.localPlayer.score,
                        isAlive: this.localPlayer.isAlive
                    });
                }
            }
            
            render() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.gameState === 'playing') {
                    // Render obstacles
                    this.combat.renderObstacles(this.ctx);
                    
                    // Render local player
                    if (this.localPlayer.isAlive) {
                        this.renderPlayer(this.localPlayer, this.localPlayer.color);
                    }
                    
                    // Render remote players
                    this.remotePlayers.forEach(player => {
                        if (player.isAlive) {
                            this.renderPlayer(player, player.color);
                        }
                    });
                    
                    // Render bullets with effects
                    this.combat.bullets.forEach(bullet => {
                        this.effects.drawBullet(bullet);
                    });
                    
                    // Render UI
                    this.renderUI();
                }
            }
            
            renderUI() {
                // Update DOM UI instead of canvas rendering for better readability
                this.updateGameUI();
            }
            
            updateGameUI() {
                if (this.gameState !== 'playing') return;
                
                const healthDisplay = document.getElementById('healthDisplay');
                const scoreDisplay = document.getElementById('scoreDisplay');
                const characterDisplay = document.getElementById('characterDisplay');
                
                if (healthDisplay) {
                    healthDisplay.textContent = `Vida: ${this.localPlayer.health}/${this.localPlayer.maxHealth}`;
                }
                
                if (scoreDisplay) {
                    scoreDisplay.textContent = `Score: ${this.localPlayer.score}`;
                }
                
                if (characterDisplay && this.localPlayer.character) {
                    characterDisplay.textContent = `Personagem: ${this.getCharacterName(this.localPlayer.character)}`;
                }
            }
            
            setupTouchControls() {
                // Joystick setup
                const joystick = document.getElementById('joystick');
                const handle = document.getElementById('joystickHandle');
                const shootButton = document.getElementById('shootButton');
                
                if (!joystick || !handle || !shootButton) return;
                
                let joystickActive = false;
                let joystickCenter = { x: 0, y: 0 };
                
                // Joystick touch events
                joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    joystickActive = true;
                    const rect = joystick.getBoundingClientRect();
                    joystickCenter.x = rect.left + rect.width / 2;
                    joystickCenter.y = rect.top + rect.height / 2;
                });
                
                joystick.addEventListener('touchmove', (e) => {
                    if (!joystickActive) return;
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - joystickCenter.x;
                    const deltaY = touch.clientY - joystickCenter.y;
                    
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const maxDistance = 25;
                    
                    if (distance <= maxDistance) {
                        handle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                    } else {
                        const angle = Math.atan2(deltaY, deltaX);
                        const x = Math.cos(angle) * maxDistance;
                        const y = Math.sin(angle) * maxDistance;
                        handle.style.transform = `translate(${x}px, ${y}px)`;
                    }
                    
                    // Set movement keys
                    const normalizedX = Math.max(-1, Math.min(1, deltaX / maxDistance));
                    const normalizedY = Math.max(-1, Math.min(1, deltaY / maxDistance));
                    
                    this.keys['KeyW'] = normalizedY < -0.3;
                    this.keys['KeyS'] = normalizedY > 0.3;
                    this.keys['KeyA'] = normalizedX < -0.3;
                    this.keys['KeyD'] = normalizedX > 0.3;
                });
                
                joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    joystickActive = false;
                    handle.style.transform = 'translate(0px, 0px)';
                    
                    // Clear movement keys
                    this.keys['KeyW'] = false;
                    this.keys['KeyS'] = false;
                    this.keys['KeyA'] = false;
                    this.keys['KeyD'] = false;
                });
                
                // Shoot button
                shootButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.gameState === 'playing') {
                        this.shoot();
                    }
                });
            }
            
            pauseGame() {
                if (this.gameState === 'playing') {
                    this.gameState = 'paused';
                    alert('Jogo pausado. Clique OK para continuar.');
                    this.gameState = 'playing';
                }
            }
            
            renderPlayer(player, color) {
                const ctx = this.ctx;
                
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.rotate(player.angle);
                
                // Player body
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Direction indicator
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(10, -2, 15, 4);
                
                ctx.restore();
                
                // Health bar
                const barWidth = 30;
                const barHeight = 4;
                const healthPercent = Math.max(0, player.health / 100);
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(player.x - barWidth/2, player.y - 25, barWidth, barHeight);
                
                ctx.fillStyle = healthPercent > 0.6 ? '#00ff00' : healthPercent > 0.3 ? '#ffaa00' : '#ff0000';
                ctx.fillRect(player.x - barWidth/2, player.y - 25, barWidth * healthPercent, barHeight);
            }
            
            gameLoop() {
                const now = Date.now();
                const deltaTime = Math.min((now - (this.lastTime || now)) / 1000, 0.016);
                this.lastTime = now;
                
                this.updateGame(deltaTime);
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // 5. INICIALIZA√á√ÉO CORRETA
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('DOM carregado, inicializando Firebase...');
                
                // 1. INICIALIZAR FIREBASE PRIMEIRO
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                
                console.log('Firebase inicializado com sucesso');
                
                // 2. SETUP AUTH OBSERVER
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('Usu√°rio logado:', user.email);
                        await game.createUserProfile();
                        game.showMainMenu();
                    } else {
                        currentUser = null;
                        console.log('Usu√°rio deslogado');
                        game.showLoginScreen();
                    }
                });
                
                // 3. CRIAR INST√ÇNCIA DO JOGO
                game = new BattleArena2D();
                
                // Disponibilizar globalmente para onclick handlers
                window.game = game;
                
                console.log('Jogo inicializado com sucesso!');
                
                // Limpeza ao fechar a p√°gina
                window.addEventListener('beforeunload', () => {
                    if (game) {
                        game.leaveRoom();
                    }
                });
                
            } catch (error) {
                console.error('Erro cr√≠tico de inicializa√ß√£o:', error);
                
                document.getElementById('loginScreen').innerHTML = `
                    <div class="container">
                        <div class="menu">
                            <h1>‚öîÔ∏è Battle Arena 2D</h1>
                            <div class="status status-error">
                                <strong>Erro Cr√≠tico:</strong><br>
                                ${error.message}<br><br>
                                Verifique sua conex√£o e recarregue a p√°gina.
                            </div>
                            <button class="btn" onclick="window.location.reload()">üîÑ Recarregar</button>
                        </div>
                    </div>
                `;
            }
        });
        
    </script>
</body>
</html>