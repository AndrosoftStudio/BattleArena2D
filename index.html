<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Arena 2D - Multiplayer P2P</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Semantic Color Tokens */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            /* Typography */
            --font-family-base: "Arial", sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;

            /* Game specific colors */
            --player-host-color: #3B82F6;
            --player-client-color: #EF4444;
            --bullet-color: #FFF;
            --arena-bg: #1a1a1a;
            --arena-wall: #4a4a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-text);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        canvas {
            display: block;
            background: var(--arena-bg);
            border: 2px solid var(--color-border);
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-16);
        }

        .menu {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .menu h1 {
            color: var(--color-primary);
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-32);
            font-weight: var(--font-weight-bold);
        }

        .menu h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-24);
        }

        .btn {
            display: block;
            width: 100%;
            padding: var(--space-16);
            margin: var(--space-8) 0;
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:active {
            background: var(--color-primary-active);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .input {
            width: 100%;
            padding: var(--space-12);
            margin: var(--space-8) 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            color: var(--color-text);
            font-size: var(--font-size-base);
        }

        .status {
            padding: var(--space-12);
            margin: var(--space-12) 0;
            border-radius: var(--radius-base);
            font-weight: var(--font-weight-medium);
        }

        .status-info {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .status-error {
            background: rgba(var(--color-red-500-rgb), 0.2);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        .status-success {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }

        .game-container {
            position: relative;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .room-code {
            font-family: monospace;
            font-size: var(--font-size-2xl);
            background: rgba(var(--color-teal-500-rgb), 0.1);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            border: 2px solid var(--color-primary);
            margin: var(--space-16) 0;
            letter-spacing: 2px;
        }

        /* User Info Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-16);
            background: rgba(var(--color-brown-600-rgb), 0.1);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-24);
            border: 1px solid var(--color-border);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
        }

        .user-email {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .btn-icon {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-8);
            cursor: pointer;
            color: var(--color-text);
            font-size: var(--font-size-lg);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--color-secondary-hover);
        }

        /* Lobby Styles */
        .lobby-section {
            margin: var(--space-24) 0;
            padding: var(--space-16);
            background: rgba(var(--color-brown-600-rgb), 0.05);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
        }

        .lobby-section h3 {
            margin-bottom: var(--space-16);
            color: var(--color-primary);
            font-size: var(--font-size-lg);
        }

        .players-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .lobby-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12);
            margin: var(--space-8) 0;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
        }

        .lobby-player.host {
            border-left: 4px solid var(--color-primary);
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--space-12);
            max-height: 200px;
            overflow-y: auto;
        }

        .character-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-12);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .character-card:hover {
            border-color: var(--color-primary);
            background: var(--color-secondary);
        }

        .character-card.selected {
            border-color: var(--color-primary);
            background: rgba(var(--color-teal-500-rgb), 0.2);
        }

        .character-emoji {
            font-size: 32px;
            margin-bottom: var(--space-8);
        }

        .character-name {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            padding: var(--space-12);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-12);
        }

        .chat-message {
            margin: var(--space-8) 0;
            line-height: 1.4;
        }

        .chat-message strong {
            color: var(--color-primary);
        }

        .chat-input-container {
            display: flex;
            gap: var(--space-8);
        }

        .chat-input-container .input {
            flex: 1;
            margin: 0;
        }

        .chat-input-container .btn {
            margin: 0;
            padding: var(--space-8) var(--space-16);
        }

        .lobby-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
            margin-top: var(--space-24);
        }

        .player-status {
            font-size: var(--font-size-sm);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
        }

        .player-status.ready {
            background: rgba(var(--color-teal-500-rgb), 0.2);
            color: var(--color-success);
        }

        .player-status.waiting {
            background: rgba(var(--color-orange-500-rgb), 0.2);
            color: var(--color-warning);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <div class="menu">
            <h1>‚öîÔ∏è Battle Arena 2D</h1>
            <p>Fa√ßa login para jogar e conectar com amigos</p>
            <button class="btn" onclick="game && game.signInWithGoogle()">üîê Login com Google</button>
            <div id="loginStatus" class="status status-info hidden">Conectando...</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="container hidden">
        <div class="menu">
            <h1>‚öîÔ∏è Battle Arena 2D</h1>
            <div id="userInfo" class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <div>
                    <div id="userName">Nome do Usu√°rio</div>
                    <div id="userEmail" class="user-email">email@example.com</div>
                </div>
                <button class="btn-icon" onclick="game && game.signOut()" title="Logout">üö™</button>
            </div>
            <button class="btn" onclick="game && game.showHostMenu()">üéØ Host Game</button>
            <button class="btn" onclick="game && game.showJoinMenu()">üîó Join Game</button>
            <button class="btn btn-secondary" onclick="game && game.showInstructions()">‚ùì How to Play</button>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="container hidden">
        <div class="menu" style="max-width: 600px;">
            <h2>Lobby</h2>
            <div class="room-code" id="lobbyRoomCode"></div>
            
            <!-- Players List -->
            <div class="lobby-section">
                <h3>Jogadores</h3>
                <div id="playersList" class="players-list"></div>
            </div>
            
            <!-- Character Selection -->
            <div class="lobby-section">
                <h3>Escolha seu Personagem</h3>
                <div id="characterGrid" class="character-grid"></div>
            </div>
            
            <!-- Chat -->
            <div class="lobby-section">
                <h3>Chat</h3>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="input" placeholder="Digite sua mensagem..." maxlength="100">
                    <button class="btn" onclick="game && game.sendChat()">Enviar</button>
                </div>
            </div>
            
            <!-- Ready Button -->
            <div class="lobby-actions">
                <button id="readyButton" class="btn" onclick="game && game.toggleReady()" disabled>Escolha um personagem</button>
                <button id="startGameButton" class="btn btn-secondary hidden" onclick="game && game.startGameAsHost()">Iniciar Jogo</button>
                <button class="btn btn-secondary" onclick="game && game.leaveRoom()">‚Üê Sair da Sala</button>
            </div>
        </div>
    </div>

    <!-- Host Menu -->
    <div id="hostMenu" class="container hidden">
        <div class="menu">
            <h2>Host Game</h2>
            <div id="hostStatus" class="status status-info">Inicializando...</div>
            <div id="roomCodeContainer" class="hidden">
                <div class="room-code" id="roomCodeDisplay"></div>
                <button class="btn btn-secondary" onclick="game && game.copyRoomCode()">üìã Copy Code</button>
            </div>
            <div id="waitingMessage" class="hidden">
                <p>Compartilhe este c√≥digo com seus amigos!</p>
                <p>Aguardando jogadores...</p>
            </div>
            <button class="btn btn-secondary" onclick="game && game.showMainMenu()">‚Üê Back</button>
        </div>
    </div>

    <!-- Join Menu -->
    <div id="joinMenu" class="container hidden">
        <div class="menu">
            <h2>Join Game</h2>
            <input type="text" id="roomCodeInput" class="input" placeholder="Digite o c√≥digo da sala" maxlength="10">
            <button class="btn" onclick="game && game.pasteRoomCode()">üìã Colar C√≥digo</button>
            <button class="btn" onclick="game && game.joinRoom()">Conectar</button>
            <div id="joinStatus" class="status status-info hidden">Conectando...</div>
            <button class="btn btn-secondary" onclick="game && game.showMainMenu()">‚Üê Back</button>
        </div>
    </div>

    <!-- Instructions -->
    <div id="instructionsMenu" class="container hidden">
        <div class="menu">
            <h2>Como Jogar</h2>
            <div style="text-align: left; line-height: 1.6;">
                <p><strong>Controles Desktop:</strong></p>
                <p>‚Ä¢ WASD - Mover</p>
                <p>‚Ä¢ Mouse - Mirar &amp; Atirar</p>
                <p>‚Ä¢ ESC - Pausar</p>
                <br>
                <p><strong>Controles Mobile:</strong></p>
                <p>‚Ä¢ Joystick esquerdo - Mover</p>
                <p>‚Ä¢ Bot√£o direito - Atirar</p>
                <br>
                <p><strong>Objetivo:</strong></p>
                <p>‚Ä¢ Elimine seus oponentes</p>
                <p>‚Ä¢ Primeiro a 10 kills vence!</p>
                <p>‚Ä¢ Respawn ap√≥s 3 segundos</p>
            </div>
            <button class="btn" onclick="game && game.showMainMenu()">‚Üê Voltar</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <!-- Game Over -->
    <div id="gameOverMenu" class="container hidden">
        <div class="menu">
            <h2 id="gameOverTitle">Game Over!</h2>
            <div id="gameOverStats"></div>
            <button class="btn" onclick="game && game.showMainMenu()">Menu Principal</button>
        </div>
    </div>

    <!-- PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- √öNICO SCRIPT TYPE="MODULE" -->
    <script type="module">
        // 1. IMPORTS DO FIREBASE (apenas uma vez!)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // 2. DECLARAR VARI√ÅVEIS GLOBAIS APENAS UMA VEZ
        let firebaseApp;
        let auth;
        let db;
        let currentUser = null;
        let peer = null;
        let connection = null;
        let game = null;
        let selectedCharacter = null;
        let isHost = false;
        let roomCode = '';
        let lobbyUnsubscribe = null;
        let chatUnsubscribe = null;
        let isReady = false;
        let roomData = null;
        
        // 3. CONFIG DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB6ho-GUxFGjjQprHHuxCDswIpWy9jtpcU",
            authDomain: "battlearena2dperplexity.firebaseapp.com",
            projectId: "battlearena2dperplexity",
            storageBucket: "battlearena2dperplexity.firebasestorage.app",
            messagingSenderId: "180775815859",
            appId: "1:180775815859:web:23b54f48f1e093ef0f3ec6",
            measurementId: "G-89P0EVPL9X"
        };

        // 4. GAME CLASS
        class BattleArena2D {
            constructor() {
                console.log('Inicializando Battle Arena 2D...');
                this.canvas = document.getElementById('gameCanvas');
                if (!this.canvas) {
                    throw new Error('Canvas n√£o encontrado');
                }
                
                this.ctx = this.canvas.getContext('2d');
                this.gameState = 'menu';
                this.playerName = 'Jogador';
                
                // Game objects
                this.localPlayer = {
                    x: 400,
                    y: 300,
                    angle: 0,
                    health: 100,
                    maxHealth: 100,
                    score: 0,
                    isAlive: true
                };
                
                this.remotePlayers = new Map();
                this.bullets = [];
                this.lastTime = 0;
                
                // Controls
                this.keys = {};
                this.mouse = { x: 0, y: 0 };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.gameLoop();
            }
            
            setupEventListeners() {
                // Keyboard
                window.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Mouse
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouse.x = e.clientX - rect.left;
                    this.mouse.y = e.clientY - rect.top;
                });
                
                this.canvas.addEventListener('mousedown', (e) => {
                    if (this.gameState === 'playing') {
                        this.shoot();
                    }
                });
            }
            
            // Menu functions
            showLoginScreen() {
                this.hideAllMenus();
                document.getElementById('loginScreen').classList.remove('hidden');
            }
            
            showMainMenu() {
                this.hideAllMenus();
                if (currentUser) {
                    document.getElementById('mainMenu').classList.remove('hidden');
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            }
            
            showHostMenu() {
                this.hideAllMenus();
                document.getElementById('hostMenu').classList.remove('hidden');
                // Aguardar um momento antes de criar host para UI atualizar
                setTimeout(() => this.createHost(), 100);
            }
            
            showJoinMenu() {
                this.hideAllMenus();
                document.getElementById('joinMenu').classList.remove('hidden');
            }
            
            showInstructions() {
                this.hideAllMenus();
                document.getElementById('instructionsMenu').classList.remove('hidden');
            }
            
            hideAllMenus() {
                const menus = ['loginScreen', 'mainMenu', 'hostMenu', 'joinMenu', 'instructionsMenu', 'gameOverMenu', 'lobbyScreen'];
                menus.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById('gameContainer').style.display = 'none';
            }
            
            // Firebase Authentication COM CORRE√á√ÉO DO POPUP
            async signInWithGoogle() {
                try {
                    const statusElement = document.getElementById('loginStatus');
                    statusElement.classList.remove('hidden');
                    statusElement.textContent = 'Conectando...';
                    statusElement.className = 'status status-info';
                    
                    const provider = new GoogleAuthProvider();
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });
                    
                    // Usar signInWithPopup com tratamento de erro espec√≠fico
                    const result = await signInWithPopup(auth, provider);
                    currentUser = result.user;
                    
                    // Salvar usu√°rio no Firestore
                    await setDoc(doc(db, 'users', result.user.uid), {
                        uid: result.user.uid,
                        email: result.user.email,
                        displayName: result.user.displayName,
                        photoURL: result.user.photoURL,
                        lastSeen: serverTimestamp(),
                        online: true
                    }, { merge: true });
                    
                    console.log('Login bem-sucedido:', result.user.email);
                    
                    statusElement.textContent = 'Login realizado com sucesso!';
                    statusElement.className = 'status status-success';
                    
                } catch (error) {
                    console.error('Erro no login:', error.code, error.message);
                    const statusElement = document.getElementById('loginStatus');
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        statusElement.textContent = 'Voc√™ fechou o popup de login. Tente novamente.';
                    } else if (error.code === 'auth/popup-blocked') {
                        statusElement.textContent = 'Popup bloqueado pelo navegador. Permita popups para este site.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        statusElement.textContent = 'Dom√≠nio n√£o autorizado. Configure o dom√≠nio no Firebase Console.';
                    } else {
                        statusElement.textContent = 'Erro ao fazer login: ' + error.message;
                    }
                    statusElement.className = 'status status-error';
                }
            }
            
            async signOut() {
                try {
                    await signOut(auth);
                    currentUser = null;
                    console.log('Logout realizado');
                } catch (error) {
                    console.error('Erro no logout:', error);
                }
            }
            
            async createUserProfile() {
                if (!currentUser) return;
                
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (!userSnap.exists()) {
                        await setDoc(userRef, {
                            uid: currentUser.uid,
                            name: currentUser.displayName || 'Usu√°rio',
                            email: currentUser.email,
                            photoURL: currentUser.photoURL || '',
                            createdAt: serverTimestamp(),
                            isOnline: true
                        });
                    } else {
                        await updateDoc(userRef, {
                            isOnline: true,
                            name: currentUser.displayName,
                            photoURL: currentUser.photoURL
                        });
                    }
                    
                    this.updateUserUI();
                } catch (error) {
                    console.error('Erro ao criar perfil:', error);
                }
            }
            
            updateUserUI() {
                if (!currentUser) return;
                
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName) userName.textContent = currentUser.displayName || 'Usu√°rio';
                if (userEmail) userEmail.textContent = currentUser.email || '';
                if (userAvatar) {
                    userAvatar.src = currentUser.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><rect width="40" height="40" fill="%23cccccc"/><text x="50%" y="55%" font-size="16" text-anchor="middle" fill="%23666666">üë§</text></svg>';
                }
            }
            
            // FIRESTORE + P2P NETWORKING COM CORRE√á√ïES
            async createHost() {
                try {
                    isHost = true;
                    roomCode = this.generateRoomCode();
                    
                    document.getElementById('hostStatus').textContent = 'Criando sala...';
                    
                    // Criar sala no Firestore
                    await setDoc(doc(db, 'rooms', roomCode), {
                        hostId: currentUser.uid,
                        hostName: currentUser.displayName,
                        players: [{
                            uid: currentUser.uid,
                            name: currentUser.displayName,
                            character: null,
                            ready: false,
                            isHost: true
                        }],
                        gameMode: 'deathmatch',
                        maxPlayers: 8,
                        status: 'lobby',
                        createdAt: serverTimestamp()
                    });
                    
                    // Iniciar peer
                    peer = new Peer(roomCode);
                    
                    peer.on('open', (id) => {
                        console.log('Sala criada:', id);
                        document.getElementById('hostStatus').textContent = 'Sala criada!';
                        document.getElementById('roomCodeDisplay').textContent = roomCode;
                        document.getElementById('roomCodeContainer').classList.remove('hidden');
                        document.getElementById('waitingMessage').classList.remove('hidden');
                        
                        // Ir para o lobby ap√≥s breve delay
                        setTimeout(() => {
                            this.hideAllMenus();
                            this.showLobby();
                        }, 1500);
                    });
                    
                    peer.on('connection', (conn) => {
                        connection = conn;
                        this.setupConnection(conn);
                    });
                    
                    peer.on('error', (err) => {
                        console.error('Erro P2P:', err);
                        document.getElementById('hostStatus').textContent = 'Erro: ' + err.message;
                        document.getElementById('hostStatus').className = 'status status-error';
                    });
                    
                } catch (error) {
                    console.error('Erro ao criar sala:', error);
                    document.getElementById('hostStatus').textContent = 'Erro ao criar sala: ' + error.message;
                    document.getElementById('hostStatus').className = 'status status-error';
                }
            }
            
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            async joinRoom() {
                const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
                if (!code) return;
                
                try {
                    isHost = false;
                    roomCode = code;
                    
                    document.getElementById('joinStatus').classList.remove('hidden');
                    document.getElementById('joinStatus').textContent = 'Verificando sala...';
                    
                    // Verificar se sala existe
                    const roomRef = doc(db, 'rooms', code);
                    const roomSnap = await getDoc(roomRef);
                    
                    if (!roomSnap.exists()) {
                        document.getElementById('joinStatus').textContent = 'Sala n√£o encontrada!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    const currentRoomData = roomSnap.data();
                    
                    if (currentRoomData.players.length >= currentRoomData.maxPlayers) {
                        document.getElementById('joinStatus').textContent = 'Sala cheia!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    if (currentRoomData.status !== 'lobby') {
                        document.getElementById('joinStatus').textContent = 'Jogo j√° iniciado!';
                        document.getElementById('joinStatus').className = 'status status-error';
                        return;
                    }
                    
                    document.getElementById('joinStatus').textContent = 'Conectando...';
                    
                    // Adicionar jogador √† sala no Firestore
                    await updateDoc(roomRef, {
                        players: arrayUnion({
                            uid: currentUser.uid,
                            name: currentUser.displayName,
                            character: null,
                            ready: false,
                            isHost: false
                        })
                    });
                    
                    // Conectar via P2P
                    peer = new Peer();
                    
                    peer.on('open', () => {
                        connection = peer.connect(code);
                        this.setupConnection(connection);
                        
                        document.getElementById('joinStatus').textContent = 'Conectado!';
                        document.getElementById('joinStatus').className = 'status status-success';
                        
                        setTimeout(() => {
                            this.hideAllMenus();
                            this.showLobby();
                        }, 1000);
                    });
                    
                    peer.on('error', (err) => {
                        console.error('Erro P2P:', err);
                        document.getElementById('joinStatus').textContent = 'Erro de conex√£o: ' + err.message;
                        document.getElementById('joinStatus').className = 'status status-error';
                    });
                    
                } catch (error) {
                    console.error('Erro ao entrar na sala:', error);
                    document.getElementById('joinStatus').textContent = 'Erro ao entrar na sala: ' + error.message;
                    document.getElementById('joinStatus').className = 'status status-error';
                }
            }
            
            setupConnection(conn) {
                conn.on('open', () => {
                    console.log('Conex√£o P2P estabelecida');
                    if (isHost) {
                        document.getElementById('hostStatus').textContent = 'Jogador conectado!';
                    } else {
                        document.getElementById('joinStatus').textContent = 'Conectado!';
                        document.getElementById('joinStatus').className = 'status status-success';
                    }
                });
                
                conn.on('data', (data) => {
                    this.handleNetworkData(data);
                });
                
                conn.on('close', () => {
                    alert('Conex√£o perdida!');
                    this.leaveRoom();
                });
                
                conn.on('error', (err) => {
                    console.error('Erro P2P:', err);
                });
            }
            
            // MOSTRAR LOBBY
            showLobby() {
                this.hideAllMenus();
                document.getElementById('lobbyScreen').classList.remove('hidden');
                document.getElementById('lobbyRoomCode').textContent = `C√≥digo: ${roomCode}`;
                
                this.initializeCharacters();
                this.listenToLobbyChanges();
                this.setupLobbyChat();
                
                // Setup chat input
                const chatInput = document.getElementById('chatInput');
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChat();
                    }
                });
            }
            
            // ESCUTAR MUDAN√áAS NO LOBBY EM TEMPO REAL
            listenToLobbyChanges() {
                const roomRef = doc(db, 'rooms', roomCode);
                
                lobbyUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        roomData = docSnap.data();
                        this.updateLobbyUI(roomData);
                    }
                });
            }
            
            // ATUALIZAR UI DO LOBBY
            updateLobbyUI(roomData) {
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';
                
                roomData.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `lobby-player ${player.isHost ? 'host' : ''}`;
                    
                    const characterName = player.character ? this.getCharacterName(player.character) : 'Escolhendo...';
                    const statusText = player.ready ? '‚úì Pronto' : '‚è≥ Aguardando';
                    const statusClass = player.ready ? 'ready' : 'waiting';
                    
                    playerDiv.innerHTML = `
                        <div>
                            <strong>${player.name}</strong>
                            ${player.isHost ? '<span style="color: var(--color-primary);"> (Host)</span>' : ''}
                        </div>
                        <div>${characterName}</div>
                        <div class="player-status ${statusClass}">${statusText}</div>
                    `;
                    playersList.appendChild(playerDiv);
                });
                
                // Atualizar bot√£o de iniciar jogo (apenas host)
                if (isHost) {
                    const startButton = document.getElementById('startGameButton');
                    const allReady = roomData.players.length > 1 && 
                                   roomData.players.every(p => p.ready && p.character);
                    
                    if (allReady) {
                        startButton.classList.remove('hidden');
                    } else {
                        startButton.classList.add('hidden');
                    }
                }
            }
            
            // INICIALIZAR PERSONAGENS
            initializeCharacters() {
                const characters = [
                    { id: 'warrior', name: 'Guerreiro', emoji: '‚öîÔ∏è' },
                    { id: 'mage', name: 'Mago', emoji: 'üßô' },
                    { id: 'archer', name: 'Arqueiro', emoji: 'üèπ' },
                    { id: 'knight', name: 'Cavaleiro', emoji: 'üõ°Ô∏è' },
                    { id: 'assassin', name: 'Assassino', emoji: 'üó°Ô∏è' },
                    { id: 'tank', name: 'Tanque', emoji: 'üõ°Ô∏è' },
                    { id: 'healer', name: 'Curandeiro', emoji: '‚ú®' },
                    { id: 'berserker', name: 'Berserker', emoji: 'üëπ' },
                    { id: 'ninja', name: 'Ninja', emoji: 'ü•∑' },
                    { id: 'paladin', name: 'Paladino', emoji: '‚õ©Ô∏è' }
                ];
                
                const characterGrid = document.getElementById('characterGrid');
                characterGrid.innerHTML = '';
                
                characters.forEach(character => {
                    const characterCard = document.createElement('div');
                    characterCard.className = 'character-card';
                    characterCard.onclick = () => this.selectCharacter(character.id);
                    
                    characterCard.innerHTML = `
                        <div class="character-emoji">${character.emoji}</div>
                        <div class="character-name">${character.name}</div>
                    `;
                    
                    characterGrid.appendChild(characterCard);
                });
            }
            
            getCharacterName(id) {
                const names = {
                    warrior: 'Guerreiro',
                    mage: 'Mago', 
                    archer: 'Arqueiro',
                    knight: 'Cavaleiro',
                    assassin: 'Assassino',
                    tank: 'Tanque',
                    healer: 'Curandeiro',
                    berserker: 'Berserker',
                    ninja: 'Ninja',
                    paladin: 'Paladino'
                };
                return names[id] || 'Desconhecido';
            }
            
            // SELECIONAR PERSONAGEM
            async selectCharacter(characterId) {
                selectedCharacter = characterId;
                
                // Atualizar UI
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.character-card').classList.add('selected');
                
                // Habilitar bot√£o ready
                const readyButton = document.getElementById('readyButton');
                readyButton.textContent = isReady ? 'N√£o Pronto' : 'Pronto';
                readyButton.disabled = false;
                
                // Atualizar no Firestore
                try {
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    const currentRoomData = roomSnap.data();
                    
                    const updatedPlayers = currentRoomData.players.map(p => {
                        if (p.uid === currentUser.uid) {
                            return { ...p, character: characterId };
                        }
                        return p;
                    });
                    
                    await updateDoc(roomRef, { players: updatedPlayers });
                    
                } catch (error) {
                    console.error('Erro ao selecionar personagem:', error);
                }
            }
            
            handleNetworkData(data) {
                switch (data.type) {
                    case 'START_GAME':
                        this.initializeGame(data.players);
                        break;
                    case 'GAME_STATE':
                        this.updateGameState(data);
                        break;
                    case 'player_update':
                        if (!this.remotePlayers.has(data.playerId)) {
                            this.remotePlayers.set(data.playerId, {});
                        }
                        const player = this.remotePlayers.get(data.playerId);
                        Object.assign(player, data);
                        break;
                        
                    case 'bullet':
                        this.bullets.push(data.bullet);
                        break;
                }
            }
            
            // TOGGLE READY
            async toggleReady() {
                if (!selectedCharacter) return;
                
                isReady = !isReady;
                
                // Atualizar UI
                const readyButton = document.getElementById('readyButton');
                readyButton.textContent = isReady ? 'N√£o Pronto' : 'Pronto';
                
                // Atualizar no Firestore
                try {
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    const currentRoomData = roomSnap.data();
                    
                    const updatedPlayers = currentRoomData.players.map(p => {
                        if (p.uid === currentUser.uid) {
                            return { ...p, ready: isReady };
                        }
                        return p;
                    });
                    
                    await updateDoc(roomRef, { players: updatedPlayers });
                    
                } catch (error) {
                    console.error('Erro ao marcar como pronto:', error);
                }
            }
            
            // SETUP CHAT DO LOBBY
            setupLobbyChat() {
                const chatRef = collection(db, 'rooms', roomCode, 'chat');
                const q = query(chatRef, orderBy('timestamp', 'asc'));
                
                chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    const chatBox = document.getElementById('chatMessages');
                    chatBox.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const msg = doc.data();
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';
                        msgDiv.innerHTML = `<strong>${msg.userName}:</strong> ${msg.message}`;
                        chatBox.appendChild(msgDiv);
                    });
                    
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            }
            
            // ENVIAR MENSAGEM NO CHAT
            async sendChat() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                try {
                    await addDoc(collection(db, 'rooms', roomCode, 'chat'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        message: message,
                        timestamp: serverTimestamp()
                    });
                    
                    chatInput.value = '';
                } catch (error) {
                    console.error('Erro ao enviar mensagem:', error);
                }
            }
            
            // INICIAR JOGO COMO HOST
            async startGameAsHost() {
                if (!isHost) return;
                
                try {
                    // Atualizar status da sala
                    await updateDoc(doc(db, 'rooms', roomCode), {
                        status: 'playing'
                    });
                    
                    // Enviar comando de in√≠cio via P2P
                    if (connection && connection.open) {
                        connection.send({
                            type: 'START_GAME',
                            players: roomData.players
                        });
                    }
                    
                    // Iniciar jogo localmente
                    this.initializeGame(roomData.players);
                    
                } catch (error) {
                    console.error('Erro ao iniciar jogo:', error);
                }
            }
            
            // INICIALIZAR JOGO
            initializeGame(players) {
                this.gameState = 'playing';
                this.hideAllMenus();
                document.getElementById('gameContainer').style.display = 'block';
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Reset player
                this.localPlayer.x = 400;
                this.localPlayer.y = 300;
                this.localPlayer.health = 100;
                this.localPlayer.score = 0;
                this.localPlayer.isAlive = true;
                
                console.log('Jogo iniciado com jogadores:', players);
            }
            
            // SAIR DA SALA
            async leaveRoom() {
                try {
                    // Remover do Firestore
                    const roomRef = doc(db, 'rooms', roomCode);
                    const roomSnap = await getDoc(roomRef);
                    
                    if (roomSnap.exists()) {
                        const currentRoomData = roomSnap.data();
                        const updatedPlayers = currentRoomData.players.filter(p => p.uid !== currentUser.uid);
                        
                        if (updatedPlayers.length === 0) {
                            // √öltima pessoa, deletar sala
                            await deleteDoc(roomRef);
                        } else {
                            await updateDoc(roomRef, { players: updatedPlayers });
                        }
                    }
                    
                    // Desconectar listeners
                    if (lobbyUnsubscribe) {
                        lobbyUnsubscribe();
                        lobbyUnsubscribe = null;
                    }
                    if (chatUnsubscribe) {
                        chatUnsubscribe();
                        chatUnsubscribe = null;
                    }
                    
                    // Fechar conex√µes P2P
                    if (connection) {
                        connection.close();
                        connection = null;
                    }
                    if (peer) {
                        peer.destroy();
                        peer = null;
                    }
                    
                    // Reset vari√°veis
                    isHost = false;
                    isReady = false;
                    selectedCharacter = null;
                    roomCode = '';
                    roomData = null;
                    
                    this.showMainMenu();
                    
                } catch (error) {
                    console.error('Erro ao sair da sala:', error);
                    // For√ßar volta ao menu mesmo com erro
                    this.showMainMenu();
                }
            }
            
            // Copy/Paste functionality
            async copyRoomCode() {
                try {
                    await navigator.clipboard.writeText(roomCode);
                    alert('C√≥digo copiado!');
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = roomCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('C√≥digo copiado!');
                }
            }
            
            async pasteRoomCode() {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('roomCodeInput').value = text.trim().toUpperCase();
                } catch (err) {
                    alert('Cole o c√≥digo manualmente.');
                }
            }
            
            // Game logic
            startGame() {
                this.gameState = 'playing';
                this.hideAllMenus();
                document.getElementById('gameContainer').style.display = 'block';
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Reset player
                this.localPlayer.x = 400;
                this.localPlayer.y = 300;
                this.localPlayer.health = 100;
                this.localPlayer.score = 0;
                this.localPlayer.isAlive = true;
            }
            
            updateGame(deltaTime) {
                if (this.gameState !== 'playing') return;
                
                this.updatePlayer(deltaTime);
                this.updateBullets(deltaTime);
                this.sendPlayerUpdate();
            }
            
            updatePlayer(deltaTime) {
                if (!this.localPlayer.isAlive) return;
                
                let moveX = 0, moveY = 0;
                const speed = 200 * deltaTime; // pixels per second
                
                if (this.keys['KeyW'] || this.keys['ArrowUp']) moveY -= 1;
                if (this.keys['KeyS'] || this.keys['ArrowDown']) moveY += 1;
                if (this.keys['KeyA'] || this.keys['ArrowLeft']) moveX -= 1;
                if (this.keys['KeyD'] || this.keys['ArrowRight']) moveX += 1;
                
                // Normalize diagonal movement
                if (moveX !== 0 || moveY !== 0) {
                    const length = Math.sqrt(moveX * moveX + moveY * moveY);
                    moveX = (moveX / length) * speed;
                    moveY = (moveY / length) * speed;
                }
                
                this.localPlayer.x += moveX;
                this.localPlayer.y += moveY;
                
                // Bounds checking
                this.localPlayer.x = Math.max(15, Math.min(this.canvas.width - 15, this.localPlayer.x));
                this.localPlayer.y = Math.max(15, Math.min(this.canvas.height - 15, this.localPlayer.y));
                
                // Update angle for aiming
                const dx = this.mouse.x - this.localPlayer.x;
                const dy = this.mouse.y - this.localPlayer.y;
                this.localPlayer.angle = Math.atan2(dy, dx);
            }
            
            updateBullets(deltaTime) {
                const bulletSpeed = 500 * deltaTime;
                
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    bullet.x += Math.cos(bullet.angle) * bulletSpeed;
                    bullet.y += Math.sin(bullet.angle) * bulletSpeed;
                    
                    // Remove bullets that are off-screen
                    if (bullet.x < 0 || bullet.x > this.canvas.width ||
                        bullet.y < 0 || bullet.y > this.canvas.height) {
                        this.bullets.splice(i, 1);
                    }
                }
            }
            
            shoot() {
                const bullet = {
                    x: this.localPlayer.x,
                    y: this.localPlayer.y,
                    angle: this.localPlayer.angle,
                    owner: 'local'
                };
                
                this.bullets.push(bullet);
                
                // Send bullet to opponent
                if (connection && connection.open) {
                    connection.send({
                        type: 'bullet',
                        bullet: bullet
                    });
                }
            }
            
            sendPlayerUpdate() {
                if (connection && connection.open) {
                    connection.send({
                        type: 'player_update',
                        playerId: 'remote',
                        x: this.localPlayer.x,
                        y: this.localPlayer.y,
                        angle: this.localPlayer.angle,
                        health: this.localPlayer.health,
                        score: this.localPlayer.score,
                        isAlive: this.localPlayer.isAlive
                    });
                }
            }
            
            render() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.gameState === 'playing') {
                    // Render local player
                    if (this.localPlayer.isAlive) {
                        this.renderPlayer(this.localPlayer, '#00ff00');
                    }
                    
                    // Render remote players
                    this.remotePlayers.forEach(player => {
                        if (player.isAlive) {
                            this.renderPlayer(player, '#ff0000');
                        }
                    });
                    
                    // Render bullets
                    this.bullets.forEach(bullet => {
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.beginPath();
                        this.ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                }
            }
            
            renderPlayer(player, color) {
                const ctx = this.ctx;
                
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.rotate(player.angle);
                
                // Player body
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Direction indicator
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(10, -2, 15, 4);
                
                ctx.restore();
                
                // Health bar
                const barWidth = 30;
                const barHeight = 4;
                const healthPercent = Math.max(0, player.health / 100);
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(player.x - barWidth/2, player.y - 25, barWidth, barHeight);
                
                ctx.fillStyle = healthPercent > 0.6 ? '#00ff00' : healthPercent > 0.3 ? '#ffaa00' : '#ff0000';
                ctx.fillRect(player.x - barWidth/2, player.y - 25, barWidth * healthPercent, barHeight);
            }
            
            gameLoop() {
                const now = Date.now();
                const deltaTime = Math.min((now - (this.lastTime || now)) / 1000, 0.016);
                this.lastTime = now;
                
                this.updateGame(deltaTime);
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // 5. INICIALIZA√á√ÉO CORRETA
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('DOM carregado, inicializando Firebase...');
                
                // 1. INICIALIZAR FIREBASE PRIMEIRO
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                
                console.log('Firebase inicializado com sucesso');
                
                // 2. SETUP AUTH OBSERVER
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('Usu√°rio logado:', user.email);
                        await game.createUserProfile();
                        game.showMainMenu();
                    } else {
                        currentUser = null;
                        console.log('Usu√°rio deslogado');
                        game.showLoginScreen();
                    }
                });
                
                // 3. CRIAR INST√ÇNCIA DO JOGO
                game = new BattleArena2D();
                
                // Disponibilizar globalmente para onclick handlers
                window.game = game;
                
                console.log('Jogo inicializado com sucesso!');
                
                // Limpeza ao fechar a p√°gina
                window.addEventListener('beforeunload', () => {
                    if (game) {
                        game.leaveRoom();
                    }
                });
                
            } catch (error) {
                console.error('Erro cr√≠tico de inicializa√ß√£o:', error);
                
                document.getElementById('loginScreen').innerHTML = `
                    <div class="container">
                        <div class="menu">
                            <h1>‚öîÔ∏è Battle Arena 2D</h1>
                            <div class="status status-error">
                                <strong>Erro Cr√≠tico:</strong><br>
                                ${error.message}<br><br>
                                Verifique sua conex√£o e recarregue a p√°gina.
                            </div>
                            <button class="btn" onclick="window.location.reload()">üîÑ Recarregar</button>
                        </div>
                    </div>
                `;
            }
        });
        
    </script>
</body>
</html>